#!/usr/bin/env node

'use strict';

const _program = require('commander');
const _shell = require('shelljs');
const _chalk = require('chalk');

_program
    .usage('gamp <message> [options]')
    .option('-n, --not-push', '不支持 git push')
    .option('-f, --force', '强制执行 git push')
    .on('--help', () => {
        console.log('没有新的文件文件变化，不push文件');
    })
    .parse(process.argv);

let message = _program.args[0];
let force = _program['force'];

let forceCommand = 'exit 0';
if (force) {
    forceCommand = 'echo force';
}
if (!message) {
    console.error(_chalk.red`- git commit message 不能为空`);
    console.log(`\n     mri gamp 'message'\n`);
    process.exit(0);
}

_shell.exec(`
    echo - git pull
    git pull
    if [ $? -ne 0 ]; then
        exit 0
    fi 
    
    echo - git status
    git status
    
    git status | grep -q 'nothing to commit' && ${forceCommand}
    
    echo - git add . 
    
    git add . 
    
    echo - git commit
    
    git commit -am '${message}'
    
    ${!_program['notPush'] &&`
        echo - git push
        git push
    `}
`);
